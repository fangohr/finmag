\documentclass[12pt,a4paper,notitlepage]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsfonts}
\usepackage{amsmath}
\input magstyle.sty

% Title Page
\title{Calculation of Demagnetisation Field using domain truncation}
\author{Gabriel Balaban for the FinMag project at the University of Southampton}
\begin{document}
\maketitle
\abstract{}
In this document the mathematics of the python modules prob\_testcases.py and solver\_nitsche.py are explained.
The demagnetisation field is found using an approach that truncates an infinite domain and uses two scalar potentials.

\newpage
\section{The Demagnetisation Field inside a Magnetic Body} 
The demagnetisation field $\dmag$ related to a magnetic body is generated by its magnetisation field $\magn$ ,
 and tends to oppose it.In this context the region in space occupied by the magnetic object of interest 
(usually a ferromagnetic material) is denoted by  $\omM$.
The complement of this region $\omV$ is considered to be a vacuum, which extends to infinity and over which
the demagnetisation field
$\dmag $ is also defined.
According to basic electrodynamics the two fields are related by

\begin{equation}\label{dmagdef} \nabla \cdotp \dmag = - \nabla \cdotp \magn \  \mbox{in} \ \omM \end{equation}

\noindent The assumption is also made that there are no free currents and that the electric displacement field does not change over time so that
\begin{equation}\label{nocurl}  \nabla \times \dmag = 0\end{equation}

\noindent This means that we can introduce a magnetic potential function $\phi$, such that

\[ \dmag = - \nabla \phi \  \mbox{in} \ \ \mathbb{R}^3 \]

\noindent which means that 

\[ - \nabla^2 \phi = \nabla \cdotp \magn \ \ \mbox{in} \ \omM \]

\noindent so that our demagnetisation field can be obtained by solving a Poisson problem.

\section{Poisson Problem for the Scalar Potential}
The poisson problem for the scalar potential $\phi$ reads
\begin{equation}\label{phidef} 
\left\{
\begin{array}{lr}
- \nabla^2 \phi = - \nabla \cdotp \magn  & \mbox{in } \ \omM \\
- \nabla^2 \phi = 0 & \mbox{in } \ \omV 
\end{array}
\right.
\end{equation}
\noindent with corresponding boundary conditions

\begin{subequations}
\begin{align}
&\mbox{jump} \left( \frac{\partial \phi}{\partial n} \right) = n \cdotp \magn  &\mbox{ on }  \domM \label{jumpbc} \\
&\lim_{\mvec{r} \in \omM \rightarrow \domM} \phi =  \lim_{\mvec{r} \in \omV \rightarrow \domM} 
\phi & \mbox{on } \domM \label{contbc} \\
&\phi \rightarrow 0 \ & \mbox{as} \ |\rvec| \in \omV \rightarrow \infty \label{openbc}
\end{align}
\end{subequations}

\noindent Where $n$ denotes the unit outward normal. The prescribed jump in the normal derivative is a 
consequence of the divergence theorem applied to the definition of $\dmag$, equation \ref{dmagdef}.
Using equation \ref{nocurl} and stokes theorem we see that the tangential component of $\nabla \phi$ or $\dmag$ is
continuous over $\domM$. Which means that the scalar potential only differs by a constant as it crosses $\domM$.
This constant is set to 0, which means that $\phi$ is continuous over $\domM$. Finally we expect the demag field $\dmag$ 
to decay to 0 far away from the magnetic body, which results in the open boundary condition
$| \phi | \rightarrow 0  \ \mbox{as} \ |\rvec| \in \omV \rightarrow \infty$ for the potential $\phi$. 


\section{Truncation of the Domain}
Since a computer cannot simulate an infinite domain there needs to be some way of dealing with the open boundary condition from
\ref{openbc}
\[\phi_2 \rightarrow 0 \ \mbox{as} \ \mvec{r} \in \omV \rightarrow \infty \]
Here the domain $\omV$ is truncated, using the rule of thumb that it should be about 5 times as large as $\omM$ in order to get
decent results. 

\section{The Discontinuous Galerkin formulation for $\phi$}
The discontinuous Galerkin formulation is a finite element discretization scheme where the 
solution is allowed to be discontinuous across element boundaries. The solution space for 
$\phi$ is restricted to 
\[ V = \{ v \in H^1 (T) \mbox{ for all } T \subset \Omega \mbox{ s.t. v is discontinous over } 
\ \partial T \} \]

\noindent Where $\Omega$ denotes the mesh and $T$ a finite element domain in $\Omega$. After integrating
equation \ref{phidef} by parts we obtain the formulation.
\\
\\
Find $\phi \in V$ such that
\begin{equation}\label{dgform}  
 \sum_T \int_T \nabla \phi \cdotp \nabla v \ dx - \int_{\partial T} \partial_n \phi \  v \ dS = \sum_T \int_T fv \ dx
\end{equation}
 \\
holds for all test functions $v \in V $. Here $f(\rvec) = - \nabla \cdotp (M)$ for $\rvec \in \omM$ and $f(\rvec) = 0$
for $\rvec \in \omV$.

\section{Nitsche's Method for $\phi$}
Continuing with the discontinuous Galerkin formulation we introduce the notation for the jump
of a function $A$ across a boundary with predefined '+' and '-' sides. 
\[ [A] = A^+ - A^- \]
Similarly the average is defined to be
\[ <A> = \frac{1}{2} (A^+ + A^-) \]
\\
A simple calculation gives the following relation
\[ [AB] = [A]<B> + <A>[B] \]
which we can now use on the boundary term of equation \ref{dgform}. The sum over boundaries of each element 
visits every facet twice, so we can instead replace it with a sum over each facet $\sum_S$, taking into account that
we can have different values on both sides of a facet. 
\begin{eqnarray*}
- \sum_T \int_{\partial T} \partial_n \phi \  v \ dS &=&  - \sum_S \int_S [\nabla \phi v ] \cdotp n \ dS \\
&=&  - \sum_S \int_S ( [\nabla \phi] <v> + <\nabla \phi> [v]) \cdotp n \ dS
\end{eqnarray*}
Here $n$ has been fixed in one of the possible directions along a facet. 
\\
\\
Nitsche's method applied to our problem \ref{dgform} consists of adding two additional terms that are equal to 0 
for the true solution, but which are allowed to carry a tolerable value for the discreet solution.
The first one is
\[ <\partial_n v> [\phi] \]
which is added for symmetry and the next one is
\[\gamma h^{-1} [\phi][v] \]
which is added for stability. Here $h$ denotes the smallest diameter of an element domain in the mesh, and
$\gamma$ is a parameter that we choose. Experiments with the code have shown that a high gamma favours better
continuity at the cost of matching the normal derivative jump condition, and vice versa.  
\\
\\
We can now formulate the Nitsche formulation for $\phi$. Since we are only interested in applying a jump condition
$ [\nabla \phi]  \cdotp n =  M \cdotp n $ on the magnetic core boundary $\domM$, we can sew together two continuous functions
together with Nitsche's method to get the result we need. Let $\phi = (\phi_0,\phi_1)$ where
$\\supp(\phi_1) \subset \omM$ and $\supp(\phi_0) \subset \omV$. The Nitsche variational problem is find  $\phi = (\phi_0,\phi_1)$ such that

\begin{eqnarray*}
&&\int_{\omM} \nabla \phi_1 \cdotp \nabla v_1 \ dx + \int_{\omV} \nabla \phi_0 \cdotp \nabla v_0 \ dx \\
&&- \int_{\domM} <\nabla \phi> [v]  + <\partial_n v> [\phi] - \gamma h^{-1} [\phi][v] \ dS \\
&&= \int_{\domM} M  \cdotp n \ dS + \int_{\omM} \nabla \cdotp M \ dx
\end{eqnarray*}

The global solution $\phi_{tot}$ is then obtained by adding together $\phi_1$ and $\phi_0$ and then halving the value
of the degrees of freedom of $\phi_{tot}$ on $\domM$.


\section{The Fredkin-Koehler approach} 
The Fredkin-Koehler approach splits the magnetic potential $\phi$ into two parts $\phi_1$ and $\phi_2$, 
\[ \phi = \phi_1 + \phi_2 \]
\noindent in order to get $\phi_2$ using the hybrid boundary/finite element method(FEM/BEM).
The Fredkin-Koehler solver solves for these two directly using domain truncation (Note not working at the moment).
\\
\\
\noindent $\phi_1$ is defined to be the solution of the Neumann problem:

\[ 
\left\{
\begin{array}{lr}
- \nabla^2 \phi_1 = \nabla \cdotp \magn  & \mbox{in } \ \omM \\
 \frac{\partial \phi_1}{\partial n}  = -n \cdotp \magn & \mbox{on } \  \partial \omM \\
 \phi_1 = 0 & \mbox{on} \ \ \omV
\end{array}
\right. 
\]
\\
\\
\noindent and $\phi_2$ is defined to be the solution of the Laplace problem
\[ 
\left\{
\begin{array}{lr}
- \nabla^2 \phi_2 = 0 & \mbox{in } \ \omM \cup \omV \\
\mbox{jump}(\phi_2) = \phi_1 & \mbox{on} \ \domM \\
\ \phi_2 \rightarrow 0 & \ \mbox{as} \ \mvec{r} \in \omV \rightarrow \infty
\end{array}
\right. 
\]
\\
\\
\noindent Adding together the two potentials $\phi_1$ and $\phi_2$ should result in the solution to the problem described in
truncdemag1. 

\end{document}          
